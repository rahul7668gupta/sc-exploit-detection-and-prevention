# Project Setup and Run Instructions

## Prerequisites

1. **Golang**
2. **Foundry and its tools**
3. **Make CLI tool**

## Setup Instructions

1. Download the git repository.
2. Navigate to the `SmartContracts` directory:
    ```sh
    cd SmartContracts
    ```
3. Copy `.env.example` to `.env`:
    ```sh
    cp .env.example .env
    ```
4. Set up the `.env` file yourself or use the shared `.env` values.
5. Ensure you have two wallets:
    - One for deploying and upgrading contracts.
    - Another for depositing and attacking the vulnerable contract.
6. Ensure both wallets have at least 0.05 ETH for executing transactions. If not, try here[https://cloud.google.com/application/web3/faucet/ethereum/holesky]
7. Ensure that `ETHEREUM_CLIENT_URL` in is set to the Holesky testnet URL.
8. Deploy the contracts to the testnet:
    ```sh
    make deploy-testnet
    ```
9. Copy the attack, proxy, and proxy admin contract addresses from the logs and set them in the respective `.env` files in the `SmartContracts` and `go-microservice` folders (refer to the video for detailed instructions).

## Running the Go Microservice

1. Navigate to the `go-microservice` directory:
    ```sh
    cd ../go-microservice
    ```
2. Copy `.env.example` to `.env`:
    ```sh
    cp .env.example .env
    ```
3. Set up the `.env` file yourself or use the shared `.env` values.
4. Use the deployed contract addresses and the contract deployer wallet private key for pause transactions. Ensure `OWNER_PRIVATE_KEY` in `go-microservice/.env` corresponds to `DEPLOYER_WALLET_ADDRESS` address in `SmartContracts/.env`.
5. Tidy up the Go modules:
    ```sh
    go mod tidy
    ```
6. Export all the `.env` values:
    ```sh
    export $(xargs < .env)
    ```
7. Run the Go application:
    ```sh
    go run main.go
    ```
8. Your server should indicate that it is monitoring transactions for the attack contract address.

## Testing the Setup

1. Run the deposit command. Ensure to use a different cast wallet than the one used for deploying (or use `--private-key` flag instead of `--account` flag if you donâ€™t have a cast wallet):
    ```sh
    make deposit
    ```
2. The go server should detect the deposit transaction but not recognize it as a reentrancy transaction.
3. Check the attack contract balance:
    ```sh
    make get-attack-deposit-value
    ```
    This should show that the attack contract has deposited 0.0002 ETH into the vulnerable smart contract.
4. Initiate a reentrancy attack:
    ```sh
    make attack
    ```
    This will trigger a reentrancy attack transaction via the attack contract. 
    The Go microservice will intercept this. Then it will send a dynamic gas-priced pause transaction to the proxy contract to front-run the attack transaction and initiate an email notification with the attack transaction hash and pause transaction hash.

5. You should receive an email about the attack transaction, and the attack transaction should fail with an error.

## Foundry Installation

**Foundry is a blazing fast, portable and modular toolkit for Ethereum application development written in Rust.**

Foundry consists of:

-   **Forge**: Ethereum testing framework (like Truffle, Hardhat and DappTools).
-   **Cast**: Swiss army knife for interacting with EVM smart contracts, sending transactions and getting chain data.
-   **Anvil**: Local Ethereum node, akin to Ganache, Hardhat Network.
-   **Chisel**: Fast, utilitarian, and verbose solidity REPL.

## Documentation

https://book.getfoundry.sh/

## Usage

### Build

```shell
$ forge build --evm-version cancun    
```

### Test

```shell
$ forge test --evm-version cancun
```

### Format

```shell
$ forge fmt
```

### Gas Snapshots

```shell
$ forge snapshot
```

### Anvil

```shell
$ anvil
```

### Deploy

```shell
$ forge script script/Counter.s.sol:CounterScript --rpc-url <your_rpc_url> --private-key <your_private_key>
```

### Cast

```shell
$ cast <subcommand>
```

### Help

```shell
$ forge --help
$ anvil --help
$ cast --help
```
